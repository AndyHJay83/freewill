<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#000000">
    <title>Notes</title>
    <style>
        * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        html, body {
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
        }

        #app {
            width: 100vw;
            height: 100vh;
            position: relative;
            background-color: #000;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            flex-direction: column;
            padding: 15px;
            padding-bottom: 0;
            color: #FFB800;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .creation-time {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-bottom: 10px;
            font-weight: normal;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 17px;
        }

        .back-button::before {
            content: "â€¹";
            font-size: 32px;
            line-height: 20px;
        }

        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .circle-button {
            width: 24px;
            height: 24px;
            border: 1.5px solid #FFB800;
            border-radius: 50%;
            background: none;
            color: #FFB800;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .circle-button.disabled {
            border-color: #666;
            color: #666;
            pointer-events: none;
        }

        .notes-title {
            color: white;
            font-size: 30px;
            font-weight: bold;
            margin-left: 5px;
            margin-bottom: 5px;
            outline: none;
            caret-color: #007AFF;
            -webkit-user-select: text;
            user-select: text;
        }

        #text-overlay {
            flex: 1;
            padding: 0 20px;
            margin-top: -5px;
            color: white;
            font-size: 16px;
            line-height: 1.5;
            outline: none;
            caret-color: #007AFF;
            -webkit-user-select: text;
            user-select: text;
            overflow-y: auto;
        }

        .toolbar {
            height: 85px;
            padding: 15px;
            padding-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .toolbar-button {
            width: 42px;
            height: 42px;
            background: none;
            border: none;
            color: #FFB800;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-button img {
            width: 42px;
            height: 42px;
            object-fit: contain;
        }

        .home-indicator {
            width: 135px;
            height: 5px;
            background: white;
            border-radius: 100px;
            margin: 8px auto;
            position: relative;
            z-index: 1;
        }

        /* Settings Panel Styles */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background-color: #000;
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 20px;
            color: white;
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 24px;
            font-weight: bold;
        }

        .close-settings {
            background: none;
            border: none;
            color: #007AFF;
            font-size: 17px;
        }

        .settings-group {
            margin-bottom: 25px;
        }

        .settings-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .settings-input {
            width: 100%;
            background: #1C1C1E;
            border: none;
            border-radius: 10px;
            padding: 12px;
            color: white;
            font-size: 17px;
            margin-bottom: 15px;
        }

        .settings-textarea {
            height: 100px;
            resize: none;
        }

        #drawing-canvas {
            flex: 1;
            background: #000;
            touch-action: none;
            display: none;
        }

        .effect-settings {
            display: none;
        }

        .effect-settings.active {
            display: block;
        }

        #order-settings {
            display: block;
        }

        .drawing-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1C1C1E;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            z-index: 2000;
            display: none;
        }

        .drawing-popup.active {
            display: block;
        }

        .drawing-popup input {
            width: 100%;
            background: #2C2C2E;
            border: none;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 17px;
            margin-bottom: 15px;
        }

        .drawing-popup button {
            width: 100%;
            background: #007AFF;
            border: none;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 17px;
            margin-top: 10px;
        }

        .drawing-list {
            margin-top: 20px;
        }

        .drawing-item {
            background: #1C1C1E;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            position: relative;
        }

        .drawing-item-title {
            font-size: 17px;
            margin-bottom: 5px;
        }

        .drawing-item-keyword {
            font-size: 13px;
            color: #666;
        }

        .delete-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1C1C1E;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            z-index: 2000;
            display: none;
            text-align: center;
        }

        .delete-popup.active {
            display: block;
        }

        .delete-popup-title {
            font-size: 17px;
            margin-bottom: 20px;
            color: white;
        }

        .delete-popup-buttons {
            display: flex;
            gap: 10px;
        }

        .delete-popup-button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 17px;
            cursor: pointer;
        }

        .delete-popup-button.cancel {
            background: #2C2C2E;
            color: #007AFF;
        }

        .delete-popup-button.delete {
            background: #FF3B30;
            color: white;
        }

        .countdown {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            color: #FFB800;
            z-index: 2000;
            display: none;
        }

        .countdown.active {
            display: block;
        }

        .drawing-popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .drawing-popup-button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 17px;
            cursor: pointer;
        }

        .drawing-popup-button.cancel {
            background: #2C2C2E;
            color: #007AFF;
        }

        .drawing-popup-button.save {
            background: #007AFF;
            color: white;
        }

        .drawing-popup input {
            margin-bottom: 10px;
        }

        /* Numpad Styles */
        .numpad-container {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1C1C1E;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .numpad-display {
            width: 100%;
            height: 50px;
            background: #2C2C2E;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            letter-spacing: 8px;
        }

        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .numpad-button {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: #2C2C2E;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .numpad-button:active {
            background: #3C3C3E;
        }

        .filtered-words {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
            width: 80%;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="header-top">
            <div class="header-left">
                <span class="back-button"></span>
                    <span id="mic-toggle" style="cursor: pointer;">All on My iPhone</span>
            </div>
            <div class="header-center">
                    <button class="circle-button disabled">â†º</button>
                    <button class="circle-button disabled">â†»</button>
            </div>
            <div class="header-right">
                    <button id="settings-button" style="background: none; border: none; padding: 0; margin: 0;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="#FFB800">
                            <path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/>
                        </svg>
                    </button>
                    <button id="start-mic" class="circle-button">â‹¯</button>
            </div>
            </div>
            <div class="creation-time">22 March 2025 at 11:35</div>
        </div>

        <div id="text-overlay" contenteditable="true" spellcheck="true">
            <h1 class="notes-title" contenteditable="true" spellcheck="true">Items</h1>
            <br><br>
            Infront of you are 4 items:
            <br><br>
            A phone<br>
            A watch<br>
            Airpods<br>
            A wallet
            <br><br>
            Place these items in any order you wish.
            <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
        </div>

        <canvas id="drawing-canvas"></canvas>

        <div class="toolbar">
            <button class="toolbar-button" id="checklist-btn">
                <img src="./images/toolbar-checklist.PNG" alt="Checklist">
                </button>
            <button class="toolbar-button" id="paperclip-btn">
                <img src="./images/toolbar-paperclip.PNG" alt="Attach">
                </button>
            <button class="toolbar-button" id="pen-btn">
                <img src="./images/toolbar-pen.PNG" alt="Draw">
                </button>
            <button class="toolbar-button" id="writing-btn">
                <img src="./images/toolbar-writing.PNG" alt="Writing Tools">
                </button>
            <button class="toolbar-button" id="new-btn">
                <img src="./images/toolbar-new.PNG" alt="New Note">
                </button>
        </div>
        <div class="home-indicator"></div>
    </div>

    <!-- Drawing Save Popup -->
    <div class="drawing-popup" id="drawing-popup">
        <input type="text" id="drawing-title" placeholder="Drawing Title">
        <input type="text" id="drawing-keyword" placeholder="Keyword">
        <div class="drawing-popup-buttons">
            <button class="drawing-popup-button cancel" id="cancel-drawing">Cancel</button>
            <button class="drawing-popup-button save" id="save-drawing">Save</button>
        </div>
    </div>

    <!-- Countdown Display -->
    <div class="countdown" id="countdown"></div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <div class="settings-title">Settings</div>
            <button class="close-settings" id="close-settings">Done</button>
        </div>
        
        <!-- Order Effect Settings -->
        <div class="effect-settings" id="order-settings">
            <div class="settings-group">
                <div class="settings-label">Microphone Start Delay (seconds)</div>
                <input type="number" class="settings-input" id="mic-delay" value="5" min="1" max="300">
            </div>
            <div class="settings-group">
                <div class="settings-label">Trigger Word</div>
                <input type="text" class="settings-input" id="trigger-word" value="perfect">
            </div>
            <div class="settings-group">
                <div class="settings-label">Response Template</div>
                <textarea class="settings-input settings-textarea" id="response-template">If I have influenced you correctly, you should've placed [ITEM 1] first, then [ITEM 2], followed by [ITEM 3] and finally, [ITEM 4]. How did I do?</textarea>
            </div>
        </div>

        <!-- Free Will Effect Settings -->
        <div class="effect-settings" id="freewill-settings">
            <div class="settings-group">
                <div class="settings-label">First Message</div>
                <textarea class="settings-input settings-textarea" id="freewill-first">Great. Now pick up another item and put it in your pocket.</textarea>
            </div>
            <div class="settings-group">
                <div class="settings-label">Second Message</div>
                <textarea class="settings-input settings-textarea" id="freewill-second">Perfect. And the last item, keep in your hands.</textarea>
            </div>
            <div class="settings-group">
                <div class="settings-label">Final Message Template</div>
                <textarea class="settings-input settings-textarea" id="freewill-final">If I have influenced you correctly, I should be holding the [FIRST], you should be holding the [LAST], and the [SECOND] should be in your pocket!</textarea>
            </div>
            <button class="save-settings" id="save-freewill">Save Changes</button>
        </div>

        <!-- Other Effect Settings (Coming Soon) -->
        <div class="effect-settings" id="other-settings">
            <div class="settings-group">
                <div class="settings-label">Updates Coming Soon</div>
                <p style="color: #666; margin-top: 10px;">New features and settings will be available in a future update.</p>
            </div>
        </div>

        <!-- Drawing Effect Settings -->
        <div class="effect-settings" id="drawing-settings">
            <div class="settings-group">
                <div class="settings-label">Saved Drawings</div>
                <div class="drawing-list" id="drawing-list">
                    <!-- Drawings will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Popup -->
    <div class="delete-popup" id="delete-popup">
        <div class="delete-popup-title">Delete Drawing?</div>
        <div class="delete-popup-buttons">
            <button class="delete-popup-button cancel" id="cancel-delete">Cancel</button>
            <button class="delete-popup-button delete" id="confirm-delete">Delete</button>
        </div>
    </div>

    <!-- Add a hidden input for dictation -->
    <input type="text" id="dictation-input" style="position: absolute; top: -9999px; left: -9999px; color: black; background: black; caret-color: transparent;">

    <!-- Add numpad HTML -->
    <div id="numpad-container" class="numpad-container">
        <div class="numpad-display" id="numpad-display"></div>
        <div class="numpad-grid">
            <button class="numpad-button">1</button>
            <button class="numpad-button">2</button>
            <button class="numpad-button">3</button>
            <button class="numpad-button">4</button>
            <button class="numpad-button">5</button>
            <button class="numpad-button">6</button>
            <button class="numpad-button">7</button>
            <button class="numpad-button">8</button>
            <button class="numpad-button">9</button>
            <button class="numpad-button" style="visibility: hidden"></button>
            <button class="numpad-button">0</button>
            <button class="numpad-button" style="visibility: hidden"></button>
        </div>
    </div>

    <div id="filtered-words" class="filtered-words"></div>

    <script>
        // Settings Panel Functionality
        const settingsButton = document.getElementById('settings-button');
        const settingsPanel = document.getElementById('settings-panel');
        const closeSettings = document.getElementById('close-settings');
        const micDelay = document.getElementById('mic-delay');
        const triggerWord = document.getElementById('trigger-word');
        const responseTemplate = document.getElementById('response-template');
        const textOverlay = document.getElementById('text-overlay');
        const drawingCanvas = document.getElementById('drawing-canvas');
        const notesTitle = document.querySelector('.notes-title');

        let currentEffect = 'order';

        // Add these at the top with other variables
        let currentDrawingData = null;
        let drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
        let isEditingDrawing = false;
        let editingDrawingId = null;
        const drawingPopup = document.getElementById('drawing-popup');
        const drawingTitle = document.getElementById('drawing-title');
        const drawingKeyword = document.getElementById('drawing-keyword');
        const saveDrawingBtn = document.getElementById('save-drawing');
        const countdownDisplay = document.getElementById('countdown');

        let drawingToDelete = null;
        const deletePopup = document.getElementById('delete-popup');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        let drawingPressTimer;
        let undoPressTimer;
        let drawingHistory = [];
        let currentHistoryIndex = -1;

        // Default drawings that will always be available
        const defaultDrawings = [
            // Original drawings
            {
                id: 'default-1',
                title: 'Cross',
                keyword: 'towards',
                imagePath: './images/drawings/cross.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-2',
                title: 'Square',
                keyword: 'fantastic',
                imagePath: './images/drawings/square.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-3',
                title: 'Circle',
                keyword: 'wonderful',
                imagePath: './images/drawings/circle.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-4',
                title: 'Triangle',
                keyword: 'fair',
                imagePath: './images/drawings/triangle.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-5',
                title: 'Waves',
                keyword: 'free',
                imagePath: './images/drawings/waves.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-6',
                title: 'Star',
                keyword: 'finally',
                imagePath: './images/drawings/star.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            // New drawings
            {
                id: 'default-7',
                title: 'Stickman',
                keyword: 'human',
                imagePath: './images/drawings/stickman.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-8',
                title: 'Smiley',
                keyword: 'happy',
                imagePath: './images/drawings/smiley.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-9',
                title: 'Heart',
                keyword: 'affectionate',
                imagePath: './images/drawings/heart.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-10',
                title: 'Boat',
                keyword: 'serene',
                imagePath: './images/drawings/boat.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-11',
                title: 'House',
                keyword: 'family',
                imagePath: './images/drawings/house.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-12',
                title: 'Bicycle',
                keyword: 'movement',
                imagePath: './images/drawings/bicycle.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-13',
                title: 'Car',
                keyword: 'speed',
                imagePath: './images/drawings/car.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-14',
                title: 'Train',
                keyword: 'momentum',
                imagePath: './images/drawings/train.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-15',
                title: 'Plane',
                keyword: 'holiday',
                imagePath: './images/drawings/plane.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-16',
                title: 'Rocket',
                keyword: 'space',
                imagePath: './images/drawings/rocket.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-17',
                title: 'Television',
                keyword: 'visual',
                imagePath: './images/drawings/tv.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-18',
                title: 'Phone',
                keyword: 'communicate',
                imagePath: './images/drawings/phone.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-19',
                title: 'Book',
                keyword: 'literature',
                imagePath: './images/drawings/book.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-20',
                title: 'Wine Glass',
                keyword: 'drink',
                imagePath: './images/drawings/glass.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-21',
                title: 'Pencil',
                keyword: 'artistic',
                imagePath: './images/drawings/pencil.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-22',
                title: 'Padlock',
                keyword: 'security',
                imagePath: './images/drawings/padlock.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-23',
                title: 'Clock',
                keyword: 'time',
                imagePath: './images/drawings/clock.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-24',
                title: 'Knife',
                keyword: 'sharp',
                imagePath: './images/drawings/knife.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-25',
                title: 'Gun',
                keyword: 'dangerous',
                imagePath: './images/drawings/gun.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-26',
                title: 'Tree',
                keyword: 'natural',
                imagePath: './images/drawings/tree.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-27',
                title: 'Flower',
                keyword: 'organic',
                imagePath: './images/drawings/flower.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-28',
                title: 'Moon',
                keyword: 'night',
                imagePath: './images/drawings/moon.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-29',
                title: 'Rain',
                keyword: 'weather',
                imagePath: './images/drawings/rain.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-30',
                title: 'Lightning',
                keyword: 'powerful',
                imagePath: './images/drawings/lightning.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-31',
                title: 'Dog',
                keyword: 'loyal',
                imagePath: './images/drawings/dog.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-32',
                title: 'Fish',
                keyword: 'underwater',
                imagePath: './images/drawings/fish.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-33',
                title: 'Bird',
                keyword: 'sky',
                imagePath: './images/drawings/bird.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-34',
                title: 'Alien',
                keyword: 'weird',
                imagePath: './images/drawings/alien.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-35',
                title: 'Ghost',
                keyword: 'spooky',
                imagePath: './images/drawings/ghost.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-36',
                title: 'Skull',
                keyword: 'morbid',
                imagePath: './images/drawings/skull.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-37',
                title: 'Scribble',
                keyword: 'nothing',
                imagePath: './images/drawings/scribble.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-38',
                title: 'NO',
                keyword: 'negative',
                imagePath: './images/drawings/no.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-39',
                title: 'Penis',
                keyword: 'naughty',
                imagePath: './images/drawings/penis.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-40',
                title: 'Offensive',
                keyword: 'offensive',
                imagePath: './images/drawings/offensive.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            }
        ];

        // Initialize drawings from localStorage and merge with defaults
        function initializeDrawings() {
            const userDrawings = JSON.parse(localStorage.getItem('drawings') || '[]');
            
            // Filter out any default drawings that might have been saved
            const filteredUserDrawings = userDrawings.filter(drawing => 
                !drawing.id.startsWith('default-')
            );
            
            // Merge default drawings with user drawings
            drawings = [...defaultDrawings, ...filteredUserDrawings];
            
            // Save the merged list back to localStorage
            localStorage.setItem('drawings', JSON.stringify(drawings));
            
            updateDrawingsList();
        }

        // Call initializeDrawings when the page loads
        initializeDrawings();

        // Modify the delete function to prevent deleting default drawings
        function deleteDrawing() {
            if (!drawingToDelete) return;
            
            // Check if trying to delete a default drawing
            if (drawingToDelete.startsWith('default-')) {
                alert('Default drawings cannot be deleted');
                hideDeletePopup();
                return;
            }
            
            drawings = drawings.filter(d => d.id !== drawingToDelete);
            localStorage.setItem('drawings', JSON.stringify(drawings));
            updateDrawingsList();
            hideDeletePopup();
        }

        // Update the drawing list to show a lock icon for default drawings
        function updateDrawingsList() {
            const drawingList = document.getElementById('drawing-list');
            if (!drawingList) return;

            drawingList.innerHTML = drawings
                .sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified))
                .map(drawing => `
                    <div class="drawing-item" data-id="${drawing.id}">
                        <div class="drawing-item-title">
                            ${drawing.title}
                            ${drawing.id.startsWith('default-') ? 
                                '<span style="color: #666; font-size: 12px;"> (default)</span>' : 
                                ''}
                        </div>
                        <div class="drawing-item-keyword">Keyword: ${drawing.keyword}</div>
                    </div>
                `).join('');

            // Add click handlers to drawing items
            document.querySelectorAll('.drawing-item').forEach(item => {
                const isDefault = item.dataset.id.startsWith('default-');
                
                // Add click handler for loading the drawing
                item.addEventListener('click', () => {
                    const drawingId = item.dataset.id;
                    const drawing = drawings.find(d => d.id === drawingId);
                    if (drawing && drawing.imagePath) {
                        loadDrawing(drawing.imagePath);
                        settingsPanel.classList.remove('active');
                    }
                });

                // Add long-press handler for deletion (non-default drawings only)
                if (!isDefault) {
                    item.addEventListener('touchstart', () => {
                        drawingPressTimer = setTimeout(() => {
                            showDeletePopup(item.dataset.id);
                        }, 500);
                    });

                    item.addEventListener('touchend', () => {
                        clearTimeout(drawingPressTimer);
                    });

                    item.addEventListener('touchmove', () => {
                        clearTimeout(drawingPressTimer);
                    });
                }
            });
        }

        // Drawing functionality
        let canvas, ctx, isDrawing = false, lastX = 0, lastY = 0, lastTapTime = 0;

        function resizeCanvas() {
            if (!canvas) return;
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            tempCtx.drawImage(canvas, 0, 0);
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Restore drawing settings
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = 3;
            
            // Restore the drawing
            ctx.drawImage(tempCanvas, 0, 0);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            let x, y;
            
            if (e.type === 'mousemove') {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            } else if (e.type === 'touchmove') {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            }

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            [lastX, lastY] = [x, y];
        }

        function startDrawing(e) {
            isDrawing = true;
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            if (e.type === 'mousedown') {
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
            } else if (e.type === 'touchstart') {
                lastX = e.touches[0].clientX - rect.left;
                lastY = e.touches[0].clientY - rect.top;
            }
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveDrawingState();
            }
        }

        function initializeDrawing() {
            canvas = document.getElementById('drawing-canvas');
            if (!canvas) return;

            ctx = canvas.getContext('2d');
            
            // Set initial canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            // Drawing settings
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = 3;

            // Remove any existing listeners
            canvas.removeEventListener('mousedown', startDrawing);
            canvas.removeEventListener('mousemove', draw);
            canvas.removeEventListener('mouseup', stopDrawing);
            canvas.removeEventListener('mouseout', stopDrawing);
            canvas.removeEventListener('touchstart', startDrawing);
            canvas.removeEventListener('touchmove', draw);
            canvas.removeEventListener('touchend', stopDrawing);

            // Add event listeners for drawing
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            // Handle window resize
            window.removeEventListener('resize', resizeCanvas);
            window.addEventListener('resize', resizeCanvas);

            // Initialize drawing history
            drawingHistory = [canvas.toDataURL()];
            currentHistoryIndex = 0;

            const undoButton = document.querySelector('.circle-button:first-child');
            
            // Setup undo button with both click and hold functionality
            undoButton.addEventListener('mousedown', () => {
                undoPressTimer = setTimeout(() => {
                    clearCanvas();
                }, 500); // Clear canvas after 500ms hold
            });

            undoButton.addEventListener('mouseup', () => {
                if (undoPressTimer) {
                    clearTimeout(undoPressTimer);
                    if (!undoButton.classList.contains('disabled')) {
                        undo();
                    }
                }
            });

            undoButton.addEventListener('mouseleave', () => {
                if (undoPressTimer) {
                    clearTimeout(undoPressTimer);
                }
            });

            // Touch events for undo button
            undoButton.addEventListener('touchstart', () => {
                undoPressTimer = setTimeout(() => {
                    clearCanvas();
                }, 500);
            });

            undoButton.addEventListener('touchend', () => {
                if (undoPressTimer) {
                    clearTimeout(undoPressTimer);
                    if (!undoButton.classList.contains('disabled')) {
                        undo();
                    }
                }
            });
        }

        // Save drawing functionality
        function showDrawingPopup(isEditing = false, drawingId = null) {
            isEditingDrawing = isEditing;
            editingDrawingId = drawingId;
            
            if (isEditing) {
                const drawing = drawings.find(d => d.id === drawingId);
                drawingTitle.value = drawing.title;
                drawingKeyword.value = drawing.keyword;
            } else {
                drawingTitle.value = '';
                drawingKeyword.value = '';
            }
            
            drawingPopup.classList.add('active');
            drawingTitle.focus();
        }

        function hideDrawingPopup() {
            drawingPopup.classList.remove('active');
            isEditingDrawing = false;
            editingDrawingId = null;
        }

        function saveDrawing() {
            const title = drawingTitle.value.trim();
            const keyword = drawingKeyword.value.trim().toLowerCase();
            
            if (!title || !keyword) {
                alert('Please enter both title and keyword');
                return;
            }

            const drawingData = canvas.toDataURL();
            
            if (isEditingDrawing) {
                const index = drawings.findIndex(d => d.id === editingDrawingId);
                drawings[index] = {
                    ...drawings[index],
                    title,
                    keyword,
                    data: drawingData,
                    lastModified: new Date().toISOString()
                };
            } else {
                drawings.push({
                    id: Date.now().toString(),
                    title,
                    keyword,
                    data: drawingData,
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                });
            }

            localStorage.setItem('drawings', JSON.stringify(drawings));
            updateDrawingsList();
            hideDrawingPopup();
        }

        function showDeletePopup(drawingId) {
            drawingToDelete = drawingId;
            deletePopup.classList.add('active');
        }

        function hideDeletePopup() {
            deletePopup.classList.remove('active');
            drawingToDelete = null;
        }

        function saveDrawingState() {
            if (currentHistoryIndex < drawingHistory.length - 1) {
                drawingHistory = drawingHistory.slice(0, currentHistoryIndex + 1);
            }
            drawingHistory.push(canvas.toDataURL());
            currentHistoryIndex++;
            
            // Enable/disable undo button based on history
            const undoButton = document.querySelector('.circle-button:first-child');
            undoButton.classList.toggle('disabled', currentHistoryIndex <= 0);
        }

        function undo() {
            if (currentHistoryIndex <= 0) return;
            
            currentHistoryIndex--;
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = drawingHistory[currentHistoryIndex];

            // Update undo button state
            const undoButton = document.querySelector('.circle-button:first-child');
            undoButton.classList.toggle('disabled', currentHistoryIndex <= 0);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawingHistory = [canvas.toDataURL()];
            currentHistoryIndex = 0;
            
            // Disable undo button after clear
            const undoButton = document.querySelector('.circle-button:first-child');
            undoButton.classList.add('disabled');
        }

        // Voice activation functionality
        let countdownTimer;
        
        function startCountdown() {
            let count = 10;
            countdownDisplay.textContent = count;
            countdownDisplay.classList.add('active');
            
            countdownTimer = setInterval(() => {
                count--;
                countdownDisplay.textContent = count;
                
                if (count === 0) {
                    clearInterval(countdownTimer);
                    countdownDisplay.classList.remove('active');
                    startVoiceRecognition();
                }
            }, 1000);
        }

        function startVoiceRecognition() {
            try {
                recognition.start();
            } catch (err) {
                console.log('Error starting recognition:', err);
                microphoneActive = false;
                countdownDisplay.classList.remove('active');
            }
        }

        // Speech Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let micStartTimeout;
        let microphoneActive = false;
        const startMicButton = document.getElementById('start-mic');
        const micToggle = document.getElementById('mic-toggle');

        // Initialize Speech Recognition if available
        try {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            // Try to suppress the beep sound
            recognition.soundstart = null;
            recognition.soundend = null;
            recognition.audiostart = null;
            recognition.audioend = null;

            // Additional settings to try to minimize system sounds
            if (typeof recognition.volume !== 'undefined') recognition.volume = 0;
            if (typeof recognition.enableBeep !== 'undefined') recognition.enableBeep = false;

            // Speech recognition event handling
            recognition.onstart = () => {
                // Attempt to play a silent audio to override system beep
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    oscillator.frequency.value = 0;
                    oscillator.connect(audioContext.destination);
                    oscillator.start(0);
                    oscillator.stop(0.001);
                } catch (e) {
                    // Silently handle any audio context errors
                }
            };

            recognition.onresult = (event) => {
                const current = event.resultIndex;
                const transcript = event.results[current][0].transcript.toLowerCase();
                
                // Only use speech recognition for the order effect
                if (currentEffect !== 'pen' && transcript.includes(triggerWord.value.toLowerCase())) {
                    const itemOrder = extractItemOrder(transcript);
                    if (itemOrder.length === 4) {
                        updateResponseText(itemOrder);
                        microphoneActive = false;
                        recognition.stop();
                    }
                }
            };

            recognition.onend = () => {
                // Only restart if still active and in the correct mode
                if (microphoneActive) {
                    try {
                        recognition.start();
                    } catch (err) {
                        // Silently handle any errors when restarting recognition
                    }
                }
            };

            recognition.onerror = (event) => {
                console.log('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    microphoneActive = false;
                    countdownDisplay.classList.remove('active');
                }
            };
        } catch (err) {
            console.log('Speech Recognition not available');
        }

        // Store the original items
        const items = {
            'phone': 'a phone',
            'watch': 'a watch',
            'airpods': 'Airpods',
            'wallet': 'a wallet'
        };

        // Settings Panel Functionality
        settingsButton.addEventListener('click', () => {
            settingsPanel.classList.add('active');
        });

        closeSettings.addEventListener('click', () => {
            settingsPanel.classList.remove('active');
        });

        // Mic Toggle Functionality
        micToggle.addEventListener('click', () => {
            if (currentEffect === 'pen') {
                // Show and focus the hidden input for dictation
                const dictationInput = document.getElementById('dictation-input');
                dictationInput.value = ''; // Clear previous input
                dictationInput.style.position = 'fixed';
                dictationInput.style.top = '50%';
                dictationInput.style.left = '50%';
                dictationInput.style.transform = 'translate(-50%, -50%)';
                dictationInput.style.width = '80%';
                dictationInput.style.height = '40px';
                dictationInput.style.fontSize = '16px';
                dictationInput.style.padding = '8px';
                dictationInput.style.border = 'none';
                dictationInput.style.background = 'black';
                dictationInput.style.color = 'black';
                dictationInput.style.caretColor = 'transparent';
                dictationInput.focus();
            } else {
                // Original microphone functionality for other modes
                microphoneActive = false;
                clearTimeout(micStartTimeout);
                try {
                    recognition.stop();
                } catch (err) {
                    // Silently handle any errors when stopping recognition
                }
                startMicButton.style.color = '#FFB800';
                startMicButton.style.borderColor = '#FFB800';
                startMicButton.disabled = false;
            }
        });

        // Start Mic Button Functionality
        startMicButton.addEventListener('click', () => {
            if (currentEffect === 'pen') {
                showDrawingPopup();
            } else if (currentEffect === 'new') {
                // Reset the Free Will effect
                textOverlay.innerHTML = `<h1 class="notes-title" contenteditable="true" spellcheck="true">Free Will</h1>
                    <br><br>
                    Infront of you, you should have 3 items:
                    <br><br>
                    A pen<br>
                    A wallet<br>
                    A watch
                    <br><br>
                    Pick up one and give it to me.`;
                initializeFreeWill();
            } else {
                // Original microphone functionality
                microphoneActive = true;
                startMicrophoneAfterDelay();
                startMicButton.style.color = '#666';
                startMicButton.style.borderColor = '#666';
                startMicButton.disabled = true;
            }
        });

        // Effect Button Listeners
        document.getElementById('checklist-btn').addEventListener('click', () => switchToEffect('order'));
        document.getElementById('new-btn').addEventListener('click', () => switchToEffect('new'));
        document.getElementById('paperclip-btn').addEventListener('click', () => switchToEffect('paperclip'));
        document.getElementById('pen-btn').addEventListener('click', () => switchToEffect('pen'));
        document.getElementById('writing-btn').addEventListener('click', () => switchToEffect('writing'));

        // Settings Input Listeners
        micDelay.addEventListener('change', () => {
            if (microphoneActive) {
                clearTimeout(micStartTimeout);
                try {
                    recognition.stop();
                } catch (err) {}
                startMicrophoneAfterDelay();
            }
        });

        triggerWord.addEventListener('change', () => {
            if (microphoneActive) {
                clearTimeout(micStartTimeout);
                try {
                    recognition.stop();
                } catch (err) {}
                startMicrophoneAfterDelay();
            }
        });

        function startMicrophoneAfterDelay() {
            if (!microphoneActive) return;
            
            const delay = parseInt(micDelay.value) * 1000;
            micStartTimeout = setTimeout(() => {
                if (!microphoneActive) {
                    startMicButton.style.color = '#FFB800';
                    startMicButton.style.borderColor = '#FFB800';
                    startMicButton.disabled = false;
                    return;
                }
                try {
                    recognition.start();
                } catch (err) {
                    // Silently handle any errors when starting recognition
                }
            }, delay);
        }

        // Initialize with Order effect
        switchToEffect('order');

        // Free Will functionality
        function initializeFreeWill() {
            const textOverlay = document.getElementById('text-overlay');
            const items = ['A pen', 'A wallet', 'A watch'];
            let scrollCount = 0;
            let selectedItems = [];
            let startY = 0;
            let startX = 0;

            // Load saved messages from localStorage
            const firstMessage = localStorage.getItem('freewill-first') || 'Great. Now pick up another item and put it in your pocket.';
            const secondMessage = localStorage.getItem('freewill-second') || 'Perfect. And the last item, keep in your hands.';
            const finalTemplate = localStorage.getItem('freewill-final') || 'If I have influenced you correctly, I should be holding the [FIRST], you should be holding the [LAST], and the [SECOND] should be in your pocket!';

            function getColumnFromX(x) {
                const width = window.innerWidth;
                const columnWidth = width / 3;
                return Math.floor(x / columnWidth);
            }

            function handleSwipe(e) {
                if (scrollCount >= 2) return; // Stop after two swipes

                const touch = e.touches[0];
                const column = getColumnFromX(touch.clientX);
                const item = items[column];

                if (!selectedItems.includes(item)) {
                    selectedItems.push(item);
                    scrollCount++;

                    // Generate new text based on scroll count
                    let newText = '';
                    if (scrollCount === 1) {
                        newText = '<br>'.repeat(100) + firstMessage + '<br>'.repeat(100);
                    } else if (scrollCount === 2) {
                        const unscrolledItem = items.find(item => !selectedItems.includes(item));
                        const finalMessage = finalTemplate
                            .replace('[FIRST]', selectedItems[0].replace('A ', ''))
                            .replace('[SECOND]', selectedItems[1].replace('A ', ''))
                            .replace('[LAST]', unscrolledItem.replace('A ', ''));
                        
                        newText = '<br>'.repeat(100) + secondMessage +
                                '<br>'.repeat(100) + finalMessage;
                    }

                    textOverlay.innerHTML += newText;
                }
            }

            textOverlay.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                startX = e.touches[0].clientX;
            });

            textOverlay.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                const deltaY = touch.clientY - startY;
                const deltaX = touch.clientX - startX;

                // Only trigger if it's a vertical swipe (up)
                if (deltaY < -50 && Math.abs(deltaX) < Math.abs(deltaY)) {
                    handleSwipe(e);
                }
            });
        }

        // Save Free Will settings
        document.getElementById('save-freewill').addEventListener('click', () => {
            const firstMessage = document.getElementById('freewill-first').value;
            const secondMessage = document.getElementById('freewill-second').value;
            const finalTemplate = document.getElementById('freewill-final').value;

            localStorage.setItem('freewill-first', firstMessage);
            localStorage.setItem('freewill-second', secondMessage);
            localStorage.setItem('freewill-final', finalTemplate);

            // Show feedback
            const saveButton = document.getElementById('save-freewill');
            saveButton.textContent = 'Saved!';
            setTimeout(() => {
                saveButton.textContent = 'Save Changes';
            }, 2000);
        });

        // Function to extract item order from speech
        function extractItemOrder(transcript) {
            const lowerTranscript = transcript.toLowerCase();
            const itemOrder = [];
            
            Object.keys(items).forEach(item => {
                const index = lowerTranscript.indexOf(item);
                if (index !== -1) {
                    itemOrder.push({
                        item: item,
                        index: index
                    });
                }
            });

            // Sort by position in transcript
            itemOrder.sort((a, b) => a.index - b.index);
            return itemOrder.map(item => item.item);
        }

        // Function to update the response text
        function updateResponseText(itemOrder) {
            const textOverlay = document.getElementById('text-overlay');
            const template = responseTemplate.value;
            
            let response = template
                .replace('[ITEM 1]', items[itemOrder[0]].replace('a ', 'the ').replace('an ', 'the '))
                .replace('[ITEM 2]', items[itemOrder[1]].replace('a ', 'the ').replace('an ', 'the '))
                .replace('[ITEM 3]', items[itemOrder[2]].replace('a ', 'the ').replace('an ', 'the '))
                .replace('[ITEM 4]', items[itemOrder[3]].replace('a ', 'the ').replace('an ', 'the '));

            // Split content at the last visible paragraph
            const content = textOverlay.innerHTML.split('Place these items in any order you wish.');
            
            // Update the hidden paragraph with many line breaks before it
            textOverlay.innerHTML = content[0] + 'Place these items in any order you wish.' + '<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>' + response;
        }

        // Add event listeners for drawing popup
        document.getElementById('save-drawing').addEventListener('click', saveDrawing);
        document.getElementById('cancel-drawing').addEventListener('click', hideDrawingPopup);
        
        // Add event listeners for delete popup
        cancelDeleteBtn.addEventListener('click', hideDeletePopup);
        confirmDeleteBtn.addEventListener('click', deleteDrawing);

        // Effect Button Listeners
        document.getElementById('checklist-btn').addEventListener('click', () => switchToEffect('order'));

        // Effect switching functions
        function switchToEffect(effect) {
            currentEffect = effect;
            const orderSettings = document.getElementById('order-settings');
            const otherSettings = document.getElementById('other-settings');
            const freewillSettings = document.getElementById('freewill-settings');
            const drawingSettings = document.getElementById('drawing-settings');
            const undoButton = document.querySelector('.circle-button:first-child');
            const redoButton = document.querySelector('.circle-button:last-child');
            const creationTime = document.querySelector('.creation-time');
            const notesTitle = document.querySelector('.notes-title');

            // Set static creation time
            creationTime.textContent = '22 March 2025 at 11:35';
            
            // Reset canvas and text overlay visibility
            drawingCanvas.style.display = 'none';
            textOverlay.style.display = 'block';

            // Update settings panel content
            if (effect === 'order') {
                orderSettings.style.display = 'block';
                otherSettings.style.display = 'none';
                freewillSettings.style.display = 'none';
                drawingSettings.style.display = 'none';
                undoButton.classList.add('disabled');
                redoButton.classList.add('disabled');
            } else if (effect === 'pen') {
                orderSettings.style.display = 'none';
                otherSettings.style.display = 'none';
                freewillSettings.style.display = 'none';
                drawingSettings.style.display = 'block';
                undoButton.classList.remove('disabled');
                redoButton.classList.add('disabled');
                updateDrawingsList();
                // Show canvas and ensure it's properly sized
                drawingCanvas.style.display = 'block';
                textOverlay.style.display = 'none';
                resizeCanvas();
            } else if (effect === 'new') {
                orderSettings.style.display = 'none';
                otherSettings.style.display = 'none';
                freewillSettings.style.display = 'block';
                drawingSettings.style.display = 'none';
                undoButton.classList.add('disabled');
                redoButton.classList.add('disabled');
            } else {
                orderSettings.style.display = 'none';
                otherSettings.style.display = 'block';
                freewillSettings.style.display = 'none';
                drawingSettings.style.display = 'none';
                undoButton.classList.add('disabled');
                redoButton.classList.add('disabled');
            }

            // Effect-specific changes
            switch(effect) {
                case 'order':
                    notesTitle.textContent = 'Items';
                    textOverlay.innerHTML = `<h1 class="notes-title" contenteditable="true" spellcheck="true">Items</h1>
                        <br>
                        Infront of you are 4 items:
                        <br><br>
                        A phone<br>
                        A watch<br>
                        Airpods<br>
                        A wallet
                        <br><br>
                        Place these items in any order you wish.
                        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>`;
                    break;
                case 'new':
                    notesTitle.textContent = 'Free Will';
                    textOverlay.innerHTML = `<h1 class="notes-title" contenteditable="true" spellcheck="true">Free Will</h1>
                        <br><br>
                        Infront of you, you should have 3 items:
                        <br><br>
                        A pen<br>
                        A wallet<br>
                        A watch
                        <br><br>
                        Pick up one and give it to me.`;
                    initializeFreeWill();
                    break;
                case 'paperclip':
                    notesTitle.textContent = 'Billet?';
                    textOverlay.innerHTML = `<h1 class="notes-title" contenteditable="true" spellcheck="true">Billet?</h1>`;
                    break;
                case 'pen':
                    notesTitle.textContent = 'Drawing';
                    textOverlay.innerHTML = `<h1 class="notes-title" contenteditable="true" spellcheck="true">Drawing</h1>`;
                    textOverlay.style.display = 'none';
                    drawingCanvas.style.display = 'block';
                    initializeDrawing();
                    break;
                case 'writing':
                    notesTitle.textContent = 'Word Filter';
                    textOverlay.innerHTML = `<h1 class="notes-title">Enter 4-digit code</h1>`;
                    currentCode = '';
                    numpadDisplay.textContent = '';
                    numpadContainer.style.display = 'block';
                    filteredWordsContainer.style.display = 'none';
                    // Load word list when switching to writing effect
                    fetch('data/Long_Nouns.txt')
                        .then(response => response.text())
                        .then(text => {
                            window.wordList = text.split('\n').map(word => word.trim()).filter(word => word.length > 0);
                        })
                        .catch(error => console.error('Error loading word list:', error));
                    break;
            }
        }

        // Function to load a drawing onto the canvas
        function loadDrawing(imagePath) {
            // Switch to pen effect if not already there
            if (currentEffect !== 'pen') {
                switchToEffect('pen');
            }
            
            // Ensure canvas is visible and properly sized
            drawingCanvas.style.display = 'block';
            textOverlay.style.display = 'none';
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Load the drawing
            const img = new Image();
            img.onload = function() {
                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Set white stroke style for visibility
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 3;
                
                // Draw the image centered on the canvas
                const scale = Math.min(
                    canvas.width / img.width,
                    canvas.height / img.height
                );
                const x = (canvas.width - img.width * scale) / 2;
                const y = (canvas.height - img.height * scale) / 2;
                
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                
                // Save this state in drawing history
                drawingHistory = [canvas.toDataURL()];
                currentHistoryIndex = 0;
            };
            img.src = imagePath;
        }

        // Add click event listener to close save popup when clicking outside
        document.addEventListener('click', function(event) {
            const savePopup = document.getElementById('save-popup');
            const saveButton = document.getElementById('save-button');
            
            // Check if save popup is visible and click is outside the popup and not on the save button
            if (savePopup && 
                savePopup.style.display === 'flex' && 
                !savePopup.contains(event.target) && 
                event.target !== saveButton) {
                savePopup.style.display = 'none';
            }
        });

        // Modify the showSavePopup function to prevent immediate closure
        function showSavePopup() {
            const savePopup = document.getElementById('save-popup');
            savePopup.style.display = 'flex';
            
            // Prevent the click event from immediately closing the popup
            event.stopPropagation();
        }

        // Add input event listener for the dictation input
        document.getElementById('dictation-input').addEventListener('input', (event) => {
            if (currentEffect !== 'pen') return;

            const transcript = event.target.value.toLowerCase();
            const matchingDrawing = drawings.find(d => transcript.includes(d.keyword.toLowerCase()));
            
            if (matchingDrawing) {
                // Hide the input and clear its value
                event.target.style.position = 'absolute';
                event.target.style.top = '-9999px';
                event.target.style.left = '-9999px';
                event.target.value = '';
                event.target.blur();

                // Load the matching drawing
                loadDrawing(matchingDrawing.imagePath);
            }
        });

        // Add blur event listener to hide the input when keyboard is dismissed
        document.getElementById('dictation-input').addEventListener('blur', (event) => {
            event.target.style.position = 'absolute';
            event.target.style.top = '-9999px';
            event.target.style.left = '-9999px';
            event.target.value = '';
        });

        // Letter shape categories
        const letterShapes = {
            straight: ['A', 'E', 'F', 'H', 'I', 'K', 'L', 'M', 'N', 'T', 'V', 'W', 'X', 'Y', 'Z'],
            mixed: ['B', 'D', 'G', 'J', 'P', 'Q', 'R', 'U', 'W', 'Y'],
            curved: ['C', 'G', 'J', 'O', 'Q', 'S', 'U', 'W']
        };

        // Initialize numpad functionality
        let currentCode = '';
        const numpadDisplay = document.getElementById('numpad-display');
        const numpadContainer = document.getElementById('numpad-container');
        const filteredWordsContainer = document.getElementById('filtered-words');

        // Add click handlers to numpad buttons
        document.querySelectorAll('.numpad-button').forEach(button => {
            button.addEventListener('click', () => {
                if (currentCode.length < 4 && button.textContent) {
                    currentCode += button.textContent;
                    numpadDisplay.textContent = currentCode;

                    if (currentCode.length === 4) {
                        // Hide numpad and filter words
                        setTimeout(() => {
                            numpadContainer.style.display = 'none';
                            filterWords(currentCode);
                        }, 500);
                    }
                }
            });
        });

        // Function to determine letter shape
        function getLetterShape(letter) {
            const straight = ['A', 'E', 'F', 'H', 'I', 'K', 'L', 'M', 'N', 'T', 'V', 'W', 'X', 'Y', 'Z'];
            const mixed = ['B', 'D', 'G', 'J', 'P', 'Q', 'R', 'U', 'W', 'Y'];
            const curved = ['C', 'G', 'J', 'O', 'Q', 'S', 'U', 'W'];
            
            letter = letter.toUpperCase();
            if (straight.includes(letter)) return 1;
            if (mixed.includes(letter)) return 2;
            if (curved.includes(letter)) return 3;
            return 0; // Default case
        }

        // Function to find vowel positions
        function getVowelPositions(word) {
            const vowels = ['A', 'E', 'I', 'O', 'U'];
            const positions = [];
            for (let i = 0; i < word.length; i++) {
                if (vowels.includes(word[i].toUpperCase())) {
                    positions.push(i + 1); // 1-based position
                }
            }
            return positions;
        }

        // Function to filter words based on code
        function filterWords(code) {
            if (!window.wordList) {
                console.error('Word list not loaded');
                return;
            }

            const length = parseInt(code[0]);
            const firstVowelPos = parseInt(code[1]);
            const secondVowelPos = parseInt(code[2]);
            const firstLetterShape = parseInt(code[3]);

            const filteredWords = window.wordList.filter(word => {
                // Check word length
                if (word.length !== length) return false;

                // Get vowel positions
                const vowelPositions = getVowelPositions(word);
                
                // Check first vowel position
                if (vowelPositions[0] !== firstVowelPos) return false;

                // Check second vowel position
                if (vowelPositions[1] !== secondVowelPos) return false;

                // Check first letter shape
                const shape = getLetterShape(word[0]);
                if (shape !== firstLetterShape) return false;

                return true;
            });

            // Display filtered words
            const filteredWordsContainer = document.getElementById('filtered-words');
            if (filteredWords.length === 0) {
                filteredWordsContainer.innerHTML = '<p>No words found matching the criteria.</p>';
            } else {
                filteredWordsContainer.innerHTML = `
                    <p>Found ${filteredWords.length} matching words:</p>
                    <div class="word-list">
                        ${filteredWords.map(word => `<span class="word">${word}</span>`).join(' ')}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
